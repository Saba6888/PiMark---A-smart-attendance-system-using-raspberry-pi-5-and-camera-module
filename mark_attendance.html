<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mark Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mark_attendance.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="static/favicon.ico" />
    <style>
      #submitAttendance {
        display: block;
        margin: 20px auto;
        background-color: #e30b5c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
      }
      #submitAttendance:hover {
        background-color: #c00950;
      }
    </style>
  </head>
  <body>
    <div class="heading-bar">
      <ul>
        <li>Mark Attendance</li>
      </ul>
    </div>

    <div class="container">
      <div class="table-container">
        <h3>Student Attendance</h3>
        <table id="attendanceTable">
          <thead>
            <tr>
              <th>Student ID</th>
              <th>Name</th>
              <th>Date</th>
              <th>Time Stamp</th>
              <th>Present</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="submitAttendance">Submit Attendance</button>
      </div>
      <div class="camera-container">
        <h3>Live Camera Feed</h3>
        <video id="cameraFeed" autoplay playsinline></video>
      </div>
    </div>

    <script>
      async function startCamera() {
        const video = document.getElementById("cameraFeed");
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
        } catch (error) {
          console.error("Error accessing webcam:", error);
        }
      }

      async function fetchAttendanceData() {
        try {
          const response = await fetch("/students");
          const students = await response.json();
          populateAttendanceTable(students);
        } catch (error) {
          console.error("Error fetching student data:", error);
        }
      }

      function populateAttendanceTable(students) {
        const tableBody = document.querySelector("#attendanceTable tbody");
        tableBody.innerHTML = "";
        const currentDate = new Date().toLocaleDateString();

        students.forEach(student => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${student.student_id}</td>
            <td>${student.name}</td>
            <td>${currentDate}</td>
            <td>${new Date().toLocaleTimeString()}</td>
            <td><input type="checkbox" id="attendance-${student.student_id}" class="attendance-checkbox"></td>
          `;
          tableBody.appendChild(row);
        });
      }

      async function fetchRecognizedFaces() {
        try {
          const response = await fetch("/recognized_faces");
          const recognizedNames = await response.json();
          markAttendance(recognizedNames);
        } catch (error) {
          console.error("Error fetching recognized faces:", error);
        }
      }

      function markAttendance(recognizedNames) {
        document.querySelectorAll("#attendanceTable tbody tr").forEach(row => {
          const nameCell = row.cells[1].textContent.trim();
          const checkbox = row.querySelector("input[type='checkbox']");
          if (recognizedNames.includes(nameCell)) {
            checkbox.checked = true;
          }
        });
      }

      async function fetchStoredAttendance() {
        try {
          const response = await fetch("/get_attendance");
          const data = await response.json();
          data.forEach(student => {
            let checkbox = document.getElementById(`attendance-${student.student_id}`);
            if (checkbox && student.present) {
              checkbox.checked = true;
            }
          });
        } catch (error) {
          console.error("Error fetching attendance:", error);
        }
      }

      document.getElementById("submitAttendance").addEventListener("click", async () => {
        const attendanceData = [];
        document.querySelectorAll("#attendanceTable tbody tr").forEach(row => {
          const student_id = row.cells[0].textContent.trim();
          const name = row.cells[1].textContent.trim();
          const date = row.cells[2].textContent.trim();
          const time = row.cells[3].textContent.trim();
          const present = row.querySelector("input[type='checkbox']").checked;
          attendanceData.push({ student_id, name, date, time, present });
        });

        try {
          const response = await fetch("/submit_attendance", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(attendanceData)
          });
          const result = await response.json();
          alert(result.message);
        } catch (error) {
          console.error("Error submitting attendance:", error);
        }
      });

      window.onload = () => {
        startCamera();
        fetchAttendanceData();
        fetchStoredAttendance(); // Fetch attendance on page load
        setInterval(fetchRecognizedFaces, 5000);
      };
    </script>
  </body>
</html>
